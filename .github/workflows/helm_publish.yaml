name: Publish Helm Chart to Docker Hub on Release
on:
  release:
    types: [published]
    tags:
      - 'helm-*'

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required to get all tags for versioning

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.x'

      - name: Package Helm Chart with Release Tag
        run: |
          CHART_VERSION=$(echo "${{ github.ref_name }}" | sed -e 's/^helm-//')
          helm package typesense-kubernetes-operator --version "$CHART_VERSION" --app-version "$CHART_VERSION"

      - name: Push Helm Chart to Docker Hub
        run: |
          CHART_FILE=$(ls *.tgz)
          CHART_NAME=$(basename "$CHART_FILE" .tgz)
          REGISTRY_PATH="oci://docker.io/${{ secrets.DOCKER_USERNAME }}/${CHART_NAME}"
          helm push "$CHART_FILE" "$REGISTRY_PATH"

      - name: Docker Logout
        if: always()
        run: docker logout